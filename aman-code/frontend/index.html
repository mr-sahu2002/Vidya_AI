<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voice RAG Agent - Multilingual</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    h1 { 
      color: #333; 
      text-align: center; 
      margin-bottom: 10px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-style: italic;
    }
    label { 
      display: block; 
      margin: 15px 0 5px; 
      font-weight: bold; 
      color: #555;
    }
    select, input[type="file"], textarea, button { 
      width: 100%; 
      padding: 12px; 
      margin-bottom: 15px; 
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    textarea { 
      height: 100px; 
      resize: vertical;
      font-family: inherit;
    }
    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }
    button:disabled { 
      background: linear-gradient(135deg, #ccc, #999);
      cursor: not-allowed; 
      transform: none;
      box-shadow: none;
    }
    #responseText { 
      white-space: pre-wrap; 
      background: #f8f9fa; 
      padding: 20px; 
      border-radius: 8px; 
      min-height: 120px; 
      border: 1px solid #e9ecef;
      font-family: inherit;
      line-height: 1.6;
    }
    #audioPlayer { 
      margin-top: 10px; 
      width: 100%;
    }
    #messages { 
      margin-bottom: 15px; 
      font-weight: bold; 
      padding: 12px;
      border-radius: 8px;
      min-height: 20px;
      transition: all 0.3s ease;
    }
    #messages.error {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    #messages.success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
    }
    #prepareAudioContainer { 
      margin-bottom: 15px; 
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
    }
    #prepareAudioContainer input {
      width: auto;
      margin: 0;
    }
    #prepareAudioContainer label {
      margin: 0;
      display: inline;
      font-weight: normal;
    }
    hr {
      margin: 30px 0;
      border: none;
      height: 1px;
      background: linear-gradient(90deg, transparent, #ddd, transparent);
    }
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-ready { background-color: #28a745; }
    .status-preparing { 
      background-color: #ffc107; 
      animation: pulse 1s infinite;
    }
    .status-error { background-color: #dc3545; }
    
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
      100% { opacity: 1; transform: scale(1); }
    }

    .language-info {
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
      color: #1976d2;
    }

    .feature-highlight {
      background: linear-gradient(135deg, #e8f5e8, #f0f8ff);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      border-left: 4px solid #667eea;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>üéôÔ∏è Voice RAG Agent</h1>
  <p class="subtitle">Multilingual AI Assistant with Text-to-Speech ‚Ä¢ Powered by Google Gemini Pro</p>

  <div class="feature-highlight">
    <strong>üåç Multilingual Support:</strong> Ask questions in any language and get responses in your preferred language with native voice synthesis.
  </div>

  <div>
    <label for="languageSelect">üåç Response Language</label>
    <select id="languageSelect">
      <option value="auto">ü§ñ Auto-Detect Language</option>
      <option value="english">üáÆüá≥ English (India)</option>
      <option value="hindi">‡§π‡§ø‡§Ç‡§¶‡•Ä Hindi</option>
      <option value="kannada">‡≤ï‡≤®‡≥ç‡≤®‡≤° Kannada</option>
      <option value="tamil">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç Tamil</option>
      <option value="telugu">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å Telugu</option>
      <option value="bengali">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ Bengali</option>
      <option value="gujarati">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä Gujarati</option>
      <option value="marathi">‡§Æ‡§∞‡§æ‡§†‡•Ä Marathi</option>
      <option value="malayalam">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç Malayalam</option>
      <option value="punjabi">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä Punjabi</option>
    </select>
    <div class="language-info" id="languageInfo">
      <strong>Auto-Detect:</strong> The system will automatically detect your query language and respond in the same language with appropriate voice.
    </div>
  </div>

  <div>
    <label for="pdfUpload">üìÑ Upload PDF Document</label>
    <input id="pdfUpload" type="file" accept="application/pdf" />
    <button id="uploadBtn" disabled>Upload PDF</button>
  </div>

  <hr />

  <div>
    <label for="queryInput">‚ùì Ask a Question</label>
    <textarea id="queryInput" placeholder="Enter your question in any language (English, ‡§π‡§ø‡§Ç‡§¶‡•Ä, ‡≤ï‡≤®‡≥ç‡≤®‡≤°, ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç, ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å, ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ, ‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä, ‡§Æ‡§∞‡§æ‡§†‡•Ä, ‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç, ‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä)..." disabled></textarea>
  </div>

  <div id="prepareAudioContainer">
    <input type="checkbox" id="prepareAudioCheckbox" checked disabled />
    <label for="prepareAudioCheckbox">üéµ Prepare Text-to-Speech Audio</label>
  </div>

  <button id="queryBtn" disabled>Get Answer</button>

  <div id="messages"></div>

  <div>
    <label>üí¨ Response:</label>
    <div id="responseText">Please upload a PDF file first to get started.</div>
    <div id="responseInfo" class="language-info" style="display:none;">
      <strong>Language:</strong> <span id="detectedLanguage">-</span> ‚Ä¢ 
      <strong>Voice:</strong> <span id="selectedVoice">-</span>
    </div>
  </div>

  <div>
    <button id="ttsBtn" disabled>
      <span class="status-indicator" id="ttsStatus"></span>
      üîä Play Text-to-Speech
    </button>
    <audio id="audioPlayer" controls style="display:none;"></audio>
  </div>
</div>

<script>
  const languageSelect = document.getElementById("languageSelect");
  const languageInfo = document.getElementById("languageInfo");
  const pdfUpload = document.getElementById("pdfUpload");
  const uploadBtn = document.getElementById("uploadBtn");
  const queryInput = document.getElementById("queryInput");
  const prepareAudioCheckbox = document.getElementById("prepareAudioCheckbox");
  const queryBtn = document.getElementById("queryBtn");
  const responseText = document.getElementById("responseText");
  const responseInfo = document.getElementById("responseInfo");
  const detectedLanguage = document.getElementById("detectedLanguage");
  const selectedVoice = document.getElementById("selectedVoice");
  const ttsBtn = document.getElementById("ttsBtn");
  const ttsStatus = document.getElementById("ttsStatus");
  const audioPlayer = document.getElementById("audioPlayer");
  const messages = document.getElementById("messages");

  let currentQueryId = null;
  let audioReady = false;
  let supportedLanguages = {};

  // Language information mapping
  const languageDescriptions = {
    "auto": "The system will automatically detect your query language and respond in the same language with appropriate voice.",
    "english": "Responses will be in clear Indian English with a natural female voice.",
    "hindi": "‡§â‡§§‡•ç‡§§‡§∞ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§î‡§∞ ‡§™‡•ç‡§∞‡§æ‡§ï‡•É‡§§‡§ø‡§ï ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§ï‡•á ‡§∏‡§æ‡§• ‡§¶‡§ø‡§è ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§",
    "kannada": "‡≤â‡≤§‡≥ç‡≤§‡≤∞‡≤ó‡≤≥‡≥Å ‡≤∏‡≥ç‡≤™‡≤∑‡≥ç‡≤ü ‡≤ï‡≤®‡≥ç‡≤®‡≤°‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤®‡≥à‡≤∏‡≤∞‡≥ç‡≤ó‡≤ø‡≤ï ‡≤ß‡≥ç‡≤µ‡≤®‡≤ø‡≤Ø‡≥ä‡≤Ç‡≤¶‡≤ø‡≤ó‡≥Ü ‡≤®‡≥Ä‡≤°‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤¶‡≥Ü.",
    "tamil": "‡Æ™‡Æ§‡Æø‡Æ≤‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡ØÜ‡Æ≥‡Æø‡Æµ‡Ææ‡Æ© ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Æø‡Æ≤‡Øç ‡Æá‡ÆØ‡Æ±‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ© ‡Æï‡ØÅ‡Æ∞‡Æ≤‡ØÅ‡Æü‡Æ©‡Øç ‡Æµ‡Æ¥‡Æô‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç.",
    "telugu": "‡∞∏‡∞Æ‡∞æ‡∞ß‡∞æ‡∞®‡∞æ‡∞≤‡±Å ‡∞∏‡±ç‡∞™‡∞∑‡±ç‡∞ü‡∞Æ‡±à‡∞® ‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å‡∞≤‡±ã ‡∞∏‡∞π‡∞ú‡∞Æ‡±à‡∞® ‡∞∏‡±ç‡∞µ‡∞∞‡∞Ç‡∞§‡±ã ‡∞Ö‡∞Ç‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞§‡∞æ‡∞Ø‡∞ø.",
    "bengali": "‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶∏‡ßç‡¶™‡¶∑‡ßç‡¶ü ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶Ø‡¶º ‡¶™‡ßç‡¶∞‡¶æ‡¶ï‡ßÉ‡¶§‡¶ø‡¶ï ‡¶ï‡¶£‡ßç‡¶†‡¶∏‡ßç‡¶¨‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§",
    "gujarati": "‡™ú‡™µ‡™æ‡™¨‡´ã ‡™∏‡´ç‡™™‡™∑‡´ç‡™ü ‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä‡™Æ‡™æ‡™Ç ‡™ï‡´Å‡™¶‡™∞‡™§‡´Ä ‡™Ö‡™µ‡™æ‡™ú ‡™∏‡™æ‡™•‡´á ‡™Ü‡™™‡™µ‡™æ‡™Æ‡™æ‡™Ç ‡™Ü‡™µ‡™∂‡´á.",
    "marathi": "‡§â‡§§‡•ç‡§§‡§∞‡•á ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§Æ‡§∞‡§æ‡§†‡•Ä‡§§ ‡§®‡•à‡§∏‡§∞‡•ç‡§ó‡§ø‡§ï ‡§Ü‡§µ‡§æ‡§ú‡§æ‡§∏‡§π ‡§¶‡§ø‡§≤‡•Ä ‡§ú‡§æ‡§§‡•Ä‡§≤.",
    "malayalam": "‡¥â‡¥§‡µç‡¥§‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥µ‡µç‡¥Ø‡¥ï‡µç‡¥§‡¥Æ‡¥æ‡¥Ø ‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥∏‡µç‡¥µ‡¥æ‡¥≠‡¥æ‡¥µ‡¥ø‡¥ï ‡¥∂‡¥¨‡µç‡¥¶‡¥§‡µç‡¥§‡µã‡¥ü‡µÜ ‡¥®‡µΩ‡¥ï‡µÅ‡¥Ç.",
    "punjabi": "‡®ú‡®µ‡®æ‡®¨ ‡®∏‡®™‡©±‡®∏‡®º‡®ü ‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä ‡®µ‡®ø‡©±‡®ö ‡®ï‡©Å‡®¶‡®∞‡®§‡©Ä ‡®Ö‡®µ‡®æ‡®ú‡®º ‡®®‡®æ‡®≤ ‡®¶‡®ø‡©±‡®§‡©á ‡®ú‡®æ‡®£‡®ó‡©á‡•§"
  };

  function showMessage(msg, isError = true) {
    messages.textContent = msg;
    messages.className = isError ? "error" : "success";
  }
  
  function clearMessage() {
    messages.textContent = "";
    messages.className = "";
  }

  // Update language info when selection changes
  languageSelect.addEventListener("change", () => {
    const selectedLang = languageSelect.value;
    languageInfo.innerHTML = `<strong>${languageSelect.options[languageSelect.selectedIndex].text}:</strong> ${languageDescriptions[selectedLang]}`;
  });

  // Enable Upload button only if file selected
  pdfUpload.addEventListener("change", () => {
    uploadBtn.disabled = !pdfUpload.files.length;
    clearMessage();
  });

  // Upload PDF with improved error handling
  uploadBtn.addEventListener("click", async () => {
    clearMessage();
    if (!pdfUpload.files.length) {
      showMessage("Please select a PDF file to upload.");
      return;
    }

    uploadBtn.disabled = true;
    uploadBtn.textContent = "Uploading...";

    const file = pdfUpload.files[0];
    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch("/api/upload-pdf", {
        method: "POST",
        body: formData,
      });

      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(errorText || res.statusText);
      }

      const data = await res.json();
      if (data.status === "success") {
        showMessage(`‚úÖ Successfully uploaded: ${data.file_name} (${data.document_count} chunks processed)`, false);

        // Enable query related UI
        queryInput.disabled = false;
        queryBtn.disabled = false;
        prepareAudioCheckbox.disabled = false;
        
        responseText.textContent = "üìö Document uploaded successfully! You can now ask questions in any supported language.";
      } else {
        showMessage(data.message || "Failed to upload PDF.");
      }
    } catch (err) {
      showMessage("Error uploading: " + err.message);
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.textContent = "Upload PDF";
    }
  });

  // Query backend with multilingual support
  queryBtn.addEventListener("click", async () => {
    clearMessage();

    if (!queryInput.value.trim()) {
      showMessage("Please enter a question.");
      return;
    }

    queryBtn.disabled = true;
    responseText.textContent = "üîÑ Processing your query...";
    responseInfo.style.display = "none";
    ttsBtn.disabled = true;
    ttsStatus.className = "status-indicator";
    audioPlayer.style.display = "none";
    audioPlayer.src = "";
    currentQueryId = null;
    audioReady = false;

    const payload = {
      query: queryInput.value.trim(),
      language: languageSelect.value,
      prepare_audio: prepareAudioCheckbox.checked
    };

    try {
      const res = await fetch("/api/query", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(errorText || res.statusText);
      }

      const data = await res.json();

      if (data.status === "success") {
        currentQueryId = data.query_id;
        responseText.textContent = data.text_response || "No response generated.";
        
        // Show language and voice information
        if (data.detected_language || data.selected_voice) {
          detectedLanguage.textContent = data.detected_language || languageSelect.value;
          selectedVoice.textContent = data.selected_voice || "Default";
          responseInfo.style.display = "block";
        }
        
        if (data.sources && data.sources.length > 0) {
          responseText.textContent += `\n\nüìö Sources: ${data.sources.join(", ")}`;
        }
        
        showMessage("‚úÖ Response generated successfully!", false);

        if (data.audio_preparing) {
          showMessage("üéµ Audio is being prepared in the background...", false);
          ttsStatus.className = "status-indicator status-preparing";
          pollAudioStatus();
        } else {
          showMessage("‚ÑπÔ∏è Audio preparation was not requested for this query.", false);
        }
        ttsBtn.disabled = !data.audio_preparing;
      } else {
        responseText.textContent = "‚ùå Failed to process query.";
        showMessage(data.error || "Error processing query.");
      }
    } catch (err) {
      responseText.textContent = "‚ùå Error occurred while processing query.";
      showMessage("Error: " + err.message);
    } finally {
      queryBtn.disabled = false;
    }
  });

  // Poll audio status to enable TTS button once ready
  async function pollAudioStatus() {
    if (!currentQueryId) return;

    try {
      const res = await fetch(`/api/audio-status/${currentQueryId}`);
      
      if (!res.ok) {
        throw new Error("Failed to check audio status");
      }

      const data = await res.json();

      if (data.audio_ready) {
        audioReady = true;
        ttsBtn.disabled = false;
        ttsStatus.className = "status-indicator status-ready";
        showMessage("üéµ Audio is ready! Click 'Play Text-to-Speech' to listen.", false);
      } else if (data.status === "preparing") {
        ttsStatus.className = "status-indicator status-preparing";
        showMessage("üîÑ Audio is still being prepared...", false);
        setTimeout(pollAudioStatus, 3000);
      } else {
        audioReady = false;
        ttsBtn.disabled = true;
        ttsStatus.className = "status-indicator status-error";
        showMessage("‚ùå " + (data.error || "Audio preparation failed."));
      }
    } catch (err) {
      ttsStatus.className = "status-indicator status-error";
      showMessage("‚ùå Audio status check error: " + err.message);
    }
  }

  // Fetch & play audio
  ttsBtn.addEventListener("click", async () => {
    if (!audioReady || !currentQueryId) {
      showMessage("Audio is not ready yet. Please wait for preparation to complete.");
      return;
    }
    
    const originalText = ttsBtn.innerHTML;
    ttsBtn.disabled = true;
    ttsBtn.innerHTML = '<span class="status-indicator status-preparing"></span>üîÑ Loading Audio...';

    try {
      const res = await fetch(`/api/audio/${currentQueryId}`);
      if (!res.ok) {
        const errorData = await res.json().catch(() => ({detail: "Failed to fetch audio"}));
        throw new Error(errorData.detail || "Failed to fetch audio");
      }
      
      const audioBlob = await res.blob();
      const audioUrl = URL.createObjectURL(audioBlob);
      audioPlayer.src = audioUrl;
      audioPlayer.style.display = "block";
      audioPlayer.play();
      showMessage("üéµ Audio is now playing in your selected language!", false);
    } catch (err) {
      showMessage("‚ùå Error playing audio: " + err.message);
    } finally {
      ttsBtn.disabled = false;
      ttsBtn.innerHTML = originalText;
    }
  });

  // Load supported languages on startup
  async function loadSupportedLanguages() {
    try {
      const res = await fetch('/api/languages');
      const data = await res.json();
      supportedLanguages = data.languages;
      console.log('Loaded supported languages:', supportedLanguages);
    } catch (err) {
      console.log('Could not load supported languages:', err);
    }
  }

  // Initialize page state
  window.addEventListener("load", () => {
    uploadBtn.disabled = true;
    queryInput.disabled = true;
    prepareAudioCheckbox.disabled = true;
    queryBtn.disabled = true;
    ttsBtn.disabled = true;
    clearMessage();
    
    // Load supported languages
    loadSupportedLanguages();
    
    // Check backend health
    fetch('/api/health')
      .then(res => res.json())
      .then(data => {
        if (data.status === 'healthy') {
          showMessage("üü¢ Multilingual Voice RAG Agent is ready!", false);
          console.log('Supported languages:', data.supported_languages);
        } else {
          showMessage("üü° Backend is running but some services may be degraded. Check configuration.");
        }
      })
      .catch(() => {
        showMessage("üî¥ Cannot connect to backend. Please check if the server is running.");
      });
  });
</script>

</body>
</html>
